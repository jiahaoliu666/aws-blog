version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 18.18.2
        - npm install -g npm@9.6.7
        - npm install rimraf --global
        - npm cache clean --force
        - npm cache verify
        - rm -rf node_modules
        - rm -rf .next
        - npm ci --legacy-peer-deps
        - echo "Node version $(node -v)"
        - echo "NPM version $(npm -v)"
        - |
          if [ ! -f .env.production ]; then
            touch .env.production
            echo "NODE_ENV=production" > .env.production
            echo "AWS_REGION=${AWS_REGION:-ap-northeast-1}" >> .env.production
            echo "NEXT_PUBLIC_AWS_REGION=${NEXT_PUBLIC_AWS_REGION:-ap-northeast-1}" >> .env.production
          fi
    build:
      commands:
        - npm run build
    postBuild:
      commands:
        - echo "Build completed"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/* 