version: 1
frontend:
  phases:
    preBuild:
      commands:
        # 安全清除快取
        - |
          echo "Starting safe cache cleanup..."
          if [ -d "node_modules" ]; then
            echo "Removing node_modules..."
            rm -rf node_modules
          fi
          if [ -d ".next" ]; then
            echo "Removing .next directory..."
            rm -rf .next
          fi
          if [ -d "~/.npm" ]; then
            echo "Cleaning npm cache..."
            npm cache clean --force || true
          fi
          echo "Cache cleanup completed"
        # Node.js 環境設置
        - |
          echo "Setting up Node.js environment..."
          nvm install 18.18.2
          nvm use 18.18.2
          npm install -g npm@9.6.7
          echo "Node version: $(node -v)"
          echo "NPM version: $(npm -v)"
        # NPM 配置
        - |
          echo "Configuring npm..."
          npm config set engine-strict false
          npm config set legacy-peer-deps true
          npm config set fetch-retry-maxtimeout 600000
          npm config set fetch-timeout 600000
        # 安裝依賴
        - |
          echo "Installing dependencies..."
          npm ci --legacy-peer-deps --no-audit || npm install --legacy-peer-deps --no-audit
        # 環境變量檢查
        - |
          echo "Checking required environment variables..."
          if [ -z "$CUSTOM_REGION" ] || [ -z "$NEXT_PUBLIC_COGNITO_CLIENT_ID" ] || [ -z "$NEXT_PUBLIC_COGNITO_USER_POOL_ID" ]; then
            echo "Error: Required environment variables are missing"
            exit 1
          fi
        # 生成環境配置文件
        - |
          echo "Generating .env.production..."
          cat << EOF > .env.production
          NODE_ENV=production
          CUSTOM_REGION=${CUSTOM_REGION:-ap-northeast-1}
          NEXT_PUBLIC_REGION=${NEXT_PUBLIC_REGION:-ap-northeast-1}
          BLOG_AVATAR_BUCKET=${BLOG_AVATAR_BUCKET:-aws-blog-avatar}
          BLOG_FEEDBACK_BUCKET=${BLOG_FEEDBACK_BUCKET:-aws-blog-feedback}
          NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
          NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID}
          BLOG_ANNOUNCEMENT_TABLE=${BLOG_ANNOUNCEMENT_TABLE:-Blog_Announcement}
          BLOG_SOLUTIONS_TABLE=${BLOG_SOLUTIONS_TABLE:-Blog_Solutions}
          BLOG_ARCHITECTURE_TABLE=${BLOG_ARCHITECTURE_TABLE:-Blog_Architecture}
          BLOG_NEWS_TABLE=${BLOG_NEWS_TABLE:-Blog_News}
          BLOG_KNOWLEDGE_TABLE=${BLOG_KNOWLEDGE_TABLE:-Blog_Knowledge}
          EOF
    build:
      commands:
        - |
          echo "Starting build process at $(date)"
          export NODE_OPTIONS="--max_old_space_size=4096"
          export NODE_ENV=production
          npm run build || {
            echo "Build failed"
            exit 1
          }
        - echo "Build completed at $(date)"
    postBuild:
      commands:
        - |
          echo "Running post-build checks..."
          if [ ! -d ".next" ]; then 
            echo "Build failed: .next directory not found" 
            exit 1
          fi
        - echo "Build completed successfully"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*  # 保留 node_modules 快取以加快構建速度
      - .next/cache/**/*   # 保留 Next.js 快取以提高效率 