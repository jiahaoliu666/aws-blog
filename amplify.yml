version: 1
frontend:
  phases:
    preBuild:
      commands:
        - 'echo "Setting up build environment"'
        - 'nvm use 18.18.2 || nvm install 18.18.2'
        - 'echo "Node $(node -v) and NPM $(npm -v)"'
        - 'rm -rf node_modules .next'
        - 'npm cache clean --force'
        - 'npm install -g npm@9.6.7'
        - 'npm config set engine-strict false'
        - 'npm config set legacy-peer-deps true'
        - 'npm config set fetch-retry-maxtimeout 600000'
        - 'npm config set fetch-timeout 600000'
        - 'npm config set registry https://registry.npmjs.org/'
        - |
          echo "Creating .npmrc file"
          cat > .npmrc << EOL
          legacy-peer-deps=true
          strict-ssl=false
          EOL
        - 'npm ci --prefer-offline --no-audit || npm install --no-audit'
        - |
          echo "Running lint setup"
          npm run lint || true
        - |
          echo "Validating environment variables..."
          for var in CUSTOM_REGION NEXT_PUBLIC_COGNITO_CLIENT_ID NEXT_PUBLIC_COGNITO_USER_POOL_ID; do
            if [ -z "${!var}" ]; then
              echo "Error: Required environment variable $var is not set"
              exit 1
            fi
          done
        - |
          echo "Creating .env.production file"
          cat > .env.production << EOL
          NODE_ENV=production
          CUSTOM_REGION=${CUSTOM_REGION}
          NEXT_PUBLIC_REGION=${NEXT_PUBLIC_REGION}
          BLOG_AVATAR_BUCKET=${BLOG_AVATAR_BUCKET}
          BLOG_FEEDBACK_BUCKET=${BLOG_FEEDBACK_BUCKET}
          NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
          NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID}
          BLOG_ANNOUNCEMENT_TABLE=${BLOG_ANNOUNCEMENT_TABLE}
          BLOG_SOLUTIONS_TABLE=${BLOG_SOLUTIONS_TABLE}
          BLOG_ARCHITECTURE_TABLE=${BLOG_ARCHITECTURE_TABLE}
          BLOG_NEWS_TABLE=${BLOG_NEWS_TABLE}
          BLOG_KNOWLEDGE_TABLE=${BLOG_KNOWLEDGE_TABLE}
          EOL
    build:
      commands:
        - |
          echo "Starting build process with following environment:"
          echo "NODE_ENV: $NODE_ENV"
          echo "CUSTOM_REGION: $CUSTOM_REGION"
          echo "NEXT_PUBLIC_REGION: $NEXT_PUBLIC_REGION"
        - 'export NODE_OPTIONS="--max_old_space_size=4096"'
        - 'export NODE_ENV=production'
        - 'export CI=true'
        - |
          if npm run build; then
            echo "Build completed successfully"
          else
            echo "Build failed"
            if [ -f ".next/error.log" ]; then
              cat .next/error.log
            fi
            exit 1
          fi
    postBuild:
      commands:
        - |
          if [ ! -d ".next" ]; then
            echo "Build failed: .next directory not found"
            exit 1
          fi
        - |
          if [ -f ".next/error.log" ]; then
            echo "Build warnings/errors found:"
            cat .next/error.log
          fi
        - 'echo "Build completed successfully"'
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/.cache/**/*
      - .next/cache/**/* 