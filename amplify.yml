version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - nvm use 18
            - npm cache clean --force
            - rm -rf node_modules
            - npm ci
            - touch .env.production
            - 'echo "NODE_ENV=production" >> .env.production'
            - "env | grep -e AWS_ -e NEXT_PUBLIC_AWS_ >> .env.production"
            - "env | grep -e NEXT_PUBLIC_COGNITO_ >> .env.production"
            - "env | grep -e DYNAMODB_ >> .env.production"
            - "env | grep -e USER_UPLOADS_BUCKET -e AWS_BLOG_FEEDBACK_BUCKET >> .env.production"
            - "env | grep -e GMAIL_ -e SES_ -e NEXT_PUBLIC_SES_ >> .env.production"
            - "env | grep -e NEXT_PUBLIC_LINE_ >> .env.production"
            - "env | grep -e DISCORD_ >> .env.production"
            - 'if [ ! -s .env.production ]; then echo "Error: env file is empty" && exit 1; fi'
        build:
          commands:
            - npm run build
            - 'if [ ! -d ".next" ]; then exit 1; fi'
            - 'if [ ! -f ".next/BUILD_ID" ]; then exit 1; fi'
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: . 