version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 18.18.2
        - npm install -g npm@9.6.7 --force --no-audit
        - npm config set engine-strict false
        - npm config set legacy-peer-deps true
        - npm install rimraf --global --force --no-audit
        - npm cache clean --force
        - rm -rf node_modules
        - rm -rf .next
        - npm ci --legacy-peer-deps --force --no-audit
        - |
          echo "Environment Setup:"
          node -v
          npm -v
        - |
          # Verify required environment variables
          if [ -z "$CUSTOM_REGION" ] || [ -z "$NEXT_PUBLIC_COGNITO_CLIENT_ID" ] || [ -z "$NEXT_PUBLIC_COGNITO_USER_POOL_ID" ]; then
            echo "Error: Required environment variables are missing"
            exit 1
          fi
        - |
          # Create or update .env.production
          cat << EOF > .env.production
          NODE_ENV=production
          CUSTOM_REGION=${CUSTOM_REGION:-ap-northeast-1}
          NEXT_PUBLIC_REGION=${NEXT_PUBLIC_REGION:-ap-northeast-1}
          BLOG_AVATAR_BUCKET=${BLOG_AVATAR_BUCKET:-blog-avatar-bucket}
          BLOG_FEEDBACK_BUCKET=${BLOG_FEEDBACK_BUCKET:-blog-feedback-bucket}
          NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
          NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID}
          BLOG_ANNOUNCEMENT_TABLE=${BLOG_ANNOUNCEMENT_TABLE:-Blog_Announcement}
          BLOG_SOLUTIONS_TABLE=${BLOG_SOLUTIONS_TABLE:-Blog_Solutions}
          BLOG_ARCHITECTURE_TABLE=${BLOG_ARCHITECTURE_TABLE:-Blog_Architecture}
          BLOG_NEWS_TABLE=${BLOG_NEWS_TABLE:-Blog_News}
          BLOG_KNOWLEDGE_TABLE=${BLOG_KNOWLEDGE_TABLE:-Blog_Knowledge}
          EOF
        - |
          echo "Environment variables set in .env.production:"
          cat .env.production | grep -v '_ID\|_KEY\|_SECRET'
    build:
      commands:
        - echo "Starting build process..."
        - npm run build
        - echo "Build completed at $(date)"
    postBuild:
      commands:
        - echo "Running post-build checks..."
        - if [ ! -d ".next" ]; then echo "Build failed: .next directory not found" && exit 1; fi
        - echo "Build completed successfully"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/* 