version: 1
frontend:
  phases:
    preBuild:
      commands:
        - 'echo "Setting up build environment"'
        - 'nvm use 18.18.2 || nvm install 18.18.2'
        - 'echo "Node $(node -v) and NPM $(npm -v)"'
        - 'rm -rf node_modules .next'
        - 'npm cache clean --force'
        - 'npm install -g npm@9.6.7'
        - 'npm config set engine-strict false'
        - 'npm config set legacy-peer-deps true'
        - 'npm ci --legacy-peer-deps --no-audit || npm install --legacy-peer-deps --no-audit'
        - |
          if [ -z "$CUSTOM_REGION" ] || [ -z "$NEXT_PUBLIC_COGNITO_CLIENT_ID" ] || [ -z "$NEXT_PUBLIC_COGNITO_USER_POOL_ID" ]; then
            echo "Error: Missing required environment variables"
            exit 1
          fi
        - |
          cat > .env.production << 'EOL'
          NODE_ENV=production
          CUSTOM_REGION=${CUSTOM_REGION:-ap-northeast-1}
          NEXT_PUBLIC_REGION=${NEXT_PUBLIC_REGION:-ap-northeast-1}
          BLOG_AVATAR_BUCKET=${BLOG_AVATAR_BUCKET:-aws-blog-avatar}
          BLOG_FEEDBACK_BUCKET=${BLOG_FEEDBACK_BUCKET:-aws-blog-feedback}
          NEXT_PUBLIC_COGNITO_CLIENT_ID=${NEXT_PUBLIC_COGNITO_CLIENT_ID}
          NEXT_PUBLIC_COGNITO_USER_POOL_ID=${NEXT_PUBLIC_COGNITO_USER_POOL_ID}
          BLOG_ANNOUNCEMENT_TABLE=${BLOG_ANNOUNCEMENT_TABLE:-Blog_Announcement}
          BLOG_SOLUTIONS_TABLE=${BLOG_SOLUTIONS_TABLE:-Blog_Solutions}
          BLOG_ARCHITECTURE_TABLE=${BLOG_ARCHITECTURE_TABLE:-Blog_Architecture}
          BLOG_NEWS_TABLE=${BLOG_NEWS_TABLE:-Blog_News}
          BLOG_KNOWLEDGE_TABLE=${BLOG_KNOWLEDGE_TABLE:-Blog_Knowledge}
          EOL
    build:
      commands:
        - 'echo "Starting build process"'
        - 'export NODE_OPTIONS="--max_old_space_size=4096"'
        - 'export NODE_ENV=production'
        - 'export CI=true'
        - 'npm run build'
    postBuild:
      commands:
        - |
          if [ ! -d ".next" ]; then
            echo "Build failed: .next directory not found"
            exit 1
          fi
        - 'echo "Build completed successfully"'
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/.cache/**/* 