version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - nvm use 18.18.2
            - npm install -g npm@9.6.7 --force
            - npm install rimraf --global --force
            - npm cache clean --force
            - npm cache verify
            - rm -rf node_modules
            - rm -rf .next
            - npm ci --legacy-peer-deps --force
            - npm install next@14.2.15 --save --legacy-peer-deps --force
            - |
              if [ ! -f .env.production ]; then
                echo "Creating .env.production file..."
                touch .env.production
                echo "NODE_ENV=production" >> .env.production
                echo "AWS_REGION=$AWS_REGION" >> .env.production
                echo "NEXT_PUBLIC_AWS_REGION=$NEXT_PUBLIC_AWS_REGION" >> .env.production
                echo "USER_UPLOADS_BUCKET=$USER_UPLOADS_BUCKET" >> .env.production
                echo "AWS_BLOG_FEEDBACK_BUCKET=$AWS_BLOG_FEEDBACK_BUCKET" >> .env.production
                echo "NEXT_PUBLIC_COGNITO_CLIENT_ID=$NEXT_PUBLIC_COGNITO_CLIENT_ID" >> .env.production
                echo "NEXT_PUBLIC_COGNITO_USER_POOL_ID=$NEXT_PUBLIC_COGNITO_USER_POOL_ID" >> .env.production
              fi
            - |
              echo "Verifying environment variables..."
              required_vars=(
                "AWS_REGION"
                "NEXT_PUBLIC_AWS_REGION"
                "USER_UPLOADS_BUCKET"
                "AWS_BLOG_FEEDBACK_BUCKET"
                "NEXT_PUBLIC_COGNITO_CLIENT_ID"
                "NEXT_PUBLIC_COGNITO_USER_POOL_ID"
              )
              missing_vars=()
              for var in "${required_vars[@]}"; do
                if [ -z "${!var}" ]; then
                  missing_vars+=("$var")
                fi
              done
              if [ ${#missing_vars[@]} -ne 0 ]; then
                echo "Error: The following required environment variables are not set:"
                printf '%s\n' "${missing_vars[@]}"
                echo "Please set these variables in the Amplify Console"
                exit 1
              fi
        build:
          commands:
            - echo "Building..."
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: . 